"""
SuperVM Work Logger - Work Note Generator
å·¥ä½œç¬”è®°ç”Ÿæˆå™¨ï¼ˆMarkdown è¾“å‡ºï¼‰
"""

from datetime import datetime
from pathlib import Path
from typing import Dict, List

def format_duration(seconds: int) -> str:
    """æ ¼å¼åŒ–æ—¶é•¿"""
    hours = seconds // 3600
    minutes = (seconds % 3600) // 60
    secs = seconds % 60
    
    if hours > 0:
        return f"{hours}h {minutes}m {secs}s"
    elif minutes > 0:
        return f"{minutes}m {secs}s"
    else:
        return f"{secs}s"

def generate_work_note(session_id: str, start_time: datetime, duration: int, 
                       file_changes: Dict[str, Dict], output_path: Path,
                       work_note_data: Dict = None) -> Path:
    """
    ç”Ÿæˆå·¥ä½œç¬”è®°
    
    Args:
        session_id: ä¼šè¯ ID
        start_time: å¼€å§‹æ—¶é—´
        duration: æŒç»­æ—¶é•¿ï¼ˆç§’ï¼‰
        file_changes: æ–‡ä»¶å˜æ›´å­—å…¸
        output_path: è¾“å‡ºç›®å½•
        work_note_data: ç”¨æˆ·è¾“å…¥çš„å·¥ä½œå†…å®¹
    
    Returns:
        ç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„
    """
    # ç”Ÿæˆæ–‡ä»¶å
    date_str = start_time.strftime('%Y-%m-%d')
    filename = f"WORK-NOTE-{date_str}-{session_id}.md"
    file_path = output_path / filename
    
    # è®¡ç®—ç»Ÿè®¡æ•°æ®
    total_files = len(file_changes)
    total_added = sum(c['lines_added'] for c in file_changes.values())
    total_removed = sum(c['lines_removed'] for c in file_changes.values())
    
    # æŒ‰ç±»å‹åˆ†ç»„
    created = []
    modified = []
    deleted = []
    
    for path, change in file_changes.items():
        if change['type'] == 'created':
            created.append((path, change))
        elif change['type'] == 'deleted':
            deleted.append((path, change))
        else:
            modified.append((path, change))
    
    # ç”Ÿæˆ Markdown
    content = f"""# Work Note - Session {session_id}

**Date**: {start_time.strftime('%Y-%m-%d %H:%M:%S')}  
**Duration**: {format_duration(duration)}  
**Status**: âœ… Completed

---

## ï¿½ Work Summary

"""
    
    # æ·»åŠ ç”¨æˆ·è¾“å…¥çš„å·¥ä½œå†…å®¹
    if work_note_data:
        if work_note_data.get('summary'):
            content += f"**ä»Šæ—¥å·¥ä½œ**: {work_note_data['summary']}\n\n"
        
        if work_note_data.get('problems'):
            content += f"### ğŸ”´ é‡åˆ°çš„é—®é¢˜\n\n{work_note_data['problems']}\n\n"
        
        if work_note_data.get('solutions'):
            content += f"### âœ… è§£å†³æ–¹æ¡ˆ\n\n{work_note_data['solutions']}\n\n"
        
        if work_note_data.get('chat'):
            content += f"### ğŸ’¬ ä¸ Copilot çš„å…³é”®å¯¹è¯\n\n"
            for chat in work_note_data['chat'].split(';'):
                if chat.strip():
                    content += f"- {chat.strip()}\n"
            content += "\n"
        
        if work_note_data.get('next_steps'):
            content += f"### ğŸ“‹ ä¸‹ä¸€æ­¥è®¡åˆ’\n\n{work_note_data['next_steps']}\n\n"
    else:
        content += "_ï¼ˆæœªå¡«å†™å·¥ä½œå†…å®¹ï¼‰_\n\n"
    
    content += """---

## ï¿½ğŸ“Š Statistics

| Metric | Value |
|--------|-------|
| Files Changed | {total_files} |
| Lines Added | {total_added} |
| Lines Removed | {total_removed} |
| Net Change | {total_added - total_removed:+d} |

---

## ğŸ“‚ Files Changed

"""
    
    # Created files
    if created:
        content += "### âœ… Created\n\n"
        for path, change in sorted(created):
            lines = change['lines_added']
            content += f"- `{path}` (+{lines} lines)\n"
        content += "\n"
    
    # Modified files
    if modified:
        content += "### âœï¸ Modified\n\n"
        for path, change in sorted(modified):
            added = change['lines_added']
            removed = change['lines_removed']
            content += f"- `{path}` (+{added} -{removed} lines)\n"
        content += "\n"
    
    # Deleted files
    if deleted:
        content += "### âŒ Deleted\n\n"
        for path, change in deleted:
            content += f"- `{path}`\n"
        content += "\n"
    
    # æ·»åŠ éªŒè¯æ¸…å•
    content += """---

## âœ… Verification Checklist

- [ ] Code compiles without errors
- [ ] Tests pass
- [ ] Documentation updated
- [ ] No sensitive data committed
- [ ] Performance benchmarks (if applicable)

---

## ğŸ“ Notes

<!-- Add your notes here -->

---

**Generated by**: SuperVM Work Logger (Python Edition)  
**Generated at**: {generated_time}
""".format(generated_time=datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
    
    # å†™å…¥æ–‡ä»¶
    output_path.mkdir(parents=True, exist_ok=True)
    with open(file_path, 'w', encoding='utf-8') as f:
        f.write(content)
    
    return file_path
